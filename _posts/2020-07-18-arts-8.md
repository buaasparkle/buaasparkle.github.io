---
layout: post
title:  "ARTS-æ‰“å¡-8"
date:   2020-07-18 20:37:18 +0800
categories: ARTS
tags: ARTS
---

# Algorithm

***[Find Eventual Safe States]***

éšæœºæŒ‘é€‰ï¼Œéš¾åº¦ Medium
æ¯”è¾ƒç›´è§‚æ˜¯ DFS éå†çš„é¢˜ç›®ï¼Œå®ç°åæäº¤æœ‰ä¸€ä¸ªè¶…æ—¶ï¼Œå°è¯•ä¿®æ”¹åæœªæœã€‚
åæ¥çœ‹äº†ä¸€ä¸‹ solutionï¼Œæåˆ°ï¼š
> This is a classic "white-gray-black" DFS algorithm

å¥½å§ï¼Œæˆ‘ä¸€å®šæ˜¯ä¸Šå­¦çš„æ—¶å€™æ²¡æœ‰å¥½å¥½å­¦ä¹ ï¼Œè™½ç„¶å®ç°æ—¶ä¹Ÿæ˜¯æ ‡è®°äº† 3 ä¸ªçŠ¶æ€ï¼Œä½†æ˜¯å¯¹ç…§è§£æçœ‹å¹¶æ²¡æœ‰å‘ç° Loop æ—¶å°½å¿«é€€å‡ºï¼Œåº”è¯¥æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´ä¸å¿…è¦çš„ dfs è€—æ—¶ã€‚

ç»“æœæ€§èƒ½ä¹Ÿä¸å°½äººæ„ï¼š
> Runtime: 952 ms, faster than 14.29% of Kotlin online submissions for Find Eventual Safe States.
Memory Usage: 98.1 MB, less than 33.33% of Kotlin online submissions for Find Eventual Safe States.

<!-- refs -->
[Find Eventual Safe States]: https://leetcode.com/problems/find-eventual-safe-states/

# Review

***[Shrink, obfuscate, and optimize your app]***

> When you use Android Studio 3.4 or Android Gradle plugin 3.4.0 and higher, R8 is the default compiler that converts your projectâ€™s Java bytecode into the DEX format that runs on the Android platform.

R8 å…¼å®¹ ProGuard çš„è§„åˆ™ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦è°ƒæ•´ã€‚

- Code Shrinkingï¼šåˆ é™¤ä¸å¿…è¦çš„ä»£ç 
```
minifyEnabled true
```

å¯è¾¾æ ‘çš„æ–¹å¼ï¼Œä¹‹å¤–çš„å°±è®¤ä¸ºç”¨ä¸åˆ°å¯ä»¥åˆ ã€‚
è‡ªå®šä¹‰ keep è§„åˆ™ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨ @Keep æ³¨è§£ï¼ˆéœ€è¦ AndroidXï¼‰

- Resource Shrinkingï¼š åˆ é™¤æ— ç”¨çš„èµ„æº
```
shrinkResources true
```
å¯ä»¥è‡ªå®šä¹‰ xml å£°æ˜èµ„æºçš„ä¿ç•™æˆ–èˆå¼ƒ

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources xmlns:tools="http://schemas.android.com/tools"
    tools:keep="@layout/l_used*_c,@layout/l_used_a,@layout/l_used_b*"
    tools:discard="@layout/unused2" />
```

å¯¹äº `Resources.getIdentifier()` å¼•ç”¨åç§°è¿™ç§ï¼Œä¼šæŠŠç¬¦åˆåç§°å­—ç¬¦ä¸²æ¨¡å¼çš„èµ„æºå…¨éƒ¨ä¿ç•™ï¼Œå¦‚æœä¸éœ€è¦ï¼Œå¯ä»¥è®¾ç½® shrinkMode ä¸º strictã€‚

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources xmlns:tools="http://schemas.android.com/tools"
    tools:shrinkMode="strict" />
```

å¯¹äºæœ‰å¤šç§èµ„æºåŒ…çš„ï¼Œå¯ä»¥è®¾ç½®ä¿ç•™éƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼š

```groovy
android {
    defaultConfig {
        ...
        resConfigs "en", "fr"
    }
}
```

- Obfuscate Code: ä»£ç æ··æ·†

ä¼šç”Ÿæˆ mapping æ–‡ä»¶å¯ä»¥é€†è¿½æº¯

- Code optimization: ä»£ç ä¼˜åŒ–

è¿›ä¸€æ­¥ä¼˜åŒ–ä»£ç ï¼Œä¸¾äº†å‡ ä¸ªä¾‹å­ï¼š

1. else å®é™…æ²¡æœ‰ç”¨åˆ°ï¼Œåˆ æ‰
1. å‡½æ•°åªä¸€æ¬¡ç”¨åˆ°ï¼Œinline
1. å¦‚æœåªæœ‰ä¸€ä¸ªç»§æ‰¿ç±»ï¼Œçˆ¶ç±»åˆæ²¡æœ‰åˆ›å»ºå®ä¾‹çš„æƒ…å†µï¼Œåˆå¹¶ä¸ºä¸€ä¸ªç±»

# Tip

```shell
sed -i "" 's/abc/xyz/g' test.txt
```
æƒ³è¦å°†ä¿®æ”¹ç›´æ¥å†™å›åˆ° test.txt æ–‡ä»¶ï¼ŒMac ä¸‹éœ€è¦æŒ‡å®š `-i ""` (é‡ç‚¹æ˜¯è¿™ä¸ªåŒå¼•å·ï¼ŒLinux ä¸‹å¥½åƒ -i å°±è¡Œäº†)

å½“ç„¶ï¼Œå¦‚æœæƒ³è¦å¤‡ä»½ä¸€ä¸‹ä¿®æ”¹ä¹‹å‰çš„å†…å®¹åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥:
```shell
sed -i.bak 's/abc/xyz/g' test.txt
```
è¿™æ · `test.txt` æ–‡ä»¶ä¸­ä¿ç•™çš„æ˜¯æ›¿æ¢åçš„ç»“æœï¼Œ`test.txt.bak` æ–‡ä»¶ä¸­æ˜¯ä¿®æ”¹ä¹‹å‰çš„å†…å®¹ã€‚

# Share

### Proguard
æœ€è¿‘åœ¨æŠ˜è…¾ Proguardï¼Œåˆ†äº«ä¸€ä¸ªå‘å’Œä¸€ä¸ªé…ç½®å§ï¼š

##### `consumerProguardFiles`

é¡¹ç›®ä¸­æœ‰å¾ˆå¤š module ï¼Œä¹‹å‰åŒäº‹åšäº†æ‹†åˆ†æ€» proguard-rules çš„ä¼˜åŒ–ï¼ŒæŠŠæ¨¡å—ç›¸å…³çš„æŒªåˆ°å…¶å†…éƒ¨å®šä¹‰ï¼Œåœ¨ build.gradle ä¸­å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æŒ‡å®šï¼š
```groovy
android {
    defaultConfig {
        consumerProguardFiles 'lib-proguard-rules.txt'
    }
    ...
}
```
è¿™æ ·çš„å¥½å¤„ä» AAR æ¥æƒ³å°±æ›´è‡ªç„¶ï¼Œå¦‚æœä¾èµ–ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œé¦–å…ˆå†…éƒ¨å®šä¹‰ä¸ç”¨å¼•ç”¨æ–¹å†æ¥å…³å¿ƒæ˜¯å¦è¦é’ˆå¯¹å…¶å†…éƒ¨ç±»æŒ‡å®šæ··æ·†è§„åˆ™äº†ï¼›å†æœ‰å¦‚æœç‰ˆæœ¬æ›´æ–°äº†ï¼Œç±»æˆ–æ¥å£æˆ–ç›®å½•å‘ç”Ÿäº†å˜åŒ–ï¼Œä¹Ÿä¸éœ€è¦å†æŠ˜è…¾è§„åˆ™æ›´æ–°çš„äº‹æƒ…ã€‚

ä¹‹å‰åªçŸ¥é“æ˜¯é’ˆå¯¹æ¨¡å—å®šä¹‰çš„ï¼Œå°±ç²—æµ…çš„ä»¥ä¸ºå…¶ä¸­çš„é…ç½®åªä¼šå½±å“è¯¥æ¨¡å—æœ¬èº«ï¼Œç”±äºåˆ›å»ºçš„ä¸€äº›æ¨¡å—éœ€è¦å…¨éƒ¨ä¸æ··æ·†ï¼Œæ‰€ä»¥ç›´æ¥åœ¨å…¶ä¸­çš„ proguard-rules.pro ä¸­åŠ å…¥äº†
```
-dontobfuscate
```
åæ¥å‘ç°ä¾èµ–å…¶çš„æ•´ä¸ª App å®é™…ä¸Šéƒ½æ²¡æœ‰æ··æ·†ï¼ŒæŸ¥äº†ä¸€ä¸‹å‘ç°æ˜¯ consumer proguard files ä¼šåœ¨ App build è¿‡ç¨‹ä¸­åµŒå…¥åˆ°åº”ç”¨çš„ proguard è§„åˆ™ä¸­ï¼Œæ‰€ä»¥ç›¸å½“äºæ•´ä¸ªé…ç½®ä¸­åŠ å…¥äº†`ä¸æ··æ·†`ï¼Œç»“æœä¹Ÿè‡ªç„¶å¦‚æ­¤äº†ã€‚

è¿™ä¸ªå‘åœ¨[è¿™ç¯‡æ–‡ç« ](https://developer.android.com/studio/build/shrink-code)ä¸­ä¹Ÿæ—©æœ‰æåŠäº†ğŸ¤¦â€â™‚ï¸ï¼š
> However, you should be aware that, because ProGuard rules are additive, certain rules that an AAR library dependency includes cannot be removed and might impact the compilation of other parts of your app. For example, if a library includes a rule to disable code optimizations, that rule disables optimizations for your entire project.

ä¿®æ”¹æ–¹å¼å°±æ˜¯ç›´æ¥æŒ‡å®šè¦ keep çš„ç±»/æ¥å£ï¼Œä¸ç”¨è¿™ç§`å¼€å…³`æ€§è´¨çš„é…ç½®äº†ã€‚

##### `-addconfigurationdebugging`

**åŠŸèƒ½**
> Specifies to instrument the processed code with debugging statements that print out suggestions for missing ProGuard configuration. 

**ä½œç”¨**
> This can be very useful to get practical hints at run-time, if your processed code crashes because it still lacks some configuration for reflection. For example, the code may be serializing classes with the GSON library and you may need some configuration for it. You can generally just copy/paste the suggestions from the 
console into your configuration file.

**æ³¨æ„**
> Counter-indication: do not use this option in release versions, as it adds obfuscation information to the processed code.

ç®€å•è¯´å°±æ˜¯ æ‰“å°å‡ºä¸€äº›å¯èƒ½ç¼ºå¤±çš„ ProGuard é…ç½®å»ºè®®ã€‚å»ºè®®åªåœ¨ debug åŒ…ä¸­å¼€å¯ã€‚

ç”±äºç›®å‰æŠ˜è…¾çš„é¡¹ç›®æ¶‰åŠæ’ä»¶åŒ–çš„ä¸œè¥¿ï¼Œéœ€è¦ä¸åŒçš„æ¨¡å—ä¹‹é—´ compileOnlyï¼Œå…¶è¾“å‡ºå°±ä¼šå¸¦æœ‰ä¸€äº›æ‰¾ä¸åˆ°æ¥å£çš„æç¤ºï¼Œå»ºè®® keep æ¥å£ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è¯•ä¸€ä¸‹çœ‹å°±å¥½äº†ã€‚

##### å‚è€ƒèµ„æ–™

[A library module may include its own ProGuard configuration file](https://developer.android.com/studio/projects/android-library)

[ProGuard Usage](https://www.guardsquare.com/en/products/proguard/manual/usage)

<!-- refs -->
[Shrink, obfuscate, and optimize your app]: https://developer.android.com/studio/build/shrink-code